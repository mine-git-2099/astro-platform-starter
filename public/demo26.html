<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¿è¥¿å·¥ä¼šè´­è¯å•†åŸ</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind theme for Red/White theme and Inter font -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-red': '#dc2626', // Tailwind red-600
                        'secondary-red': '#f87171', // Tailwind red-400
                        'light-bg': '#fefefe',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'Noto Sans', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar for webkit browsers for a cleaner look */
        ::-webkit-scrollbar {
            display: none;
        }
        /* Mobile-first base styles */
        body {
            -webkit-overflow-scrolling: touch;
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        /* Ensure content is below header and above footer */
        .content-area {
            padding-top: 56px; /* Header height */
            padding-bottom: 64px; /* Footer height */
            min-height: 100vh;
        }
        /* Custom class for the pharmacy logo/icon */
        .pill-icon {
            font-size: 24px;
            color: #dc2626;
            margin-right: 8px;
        }
        /* Style for the fixed bottom navigation */
        .nav-button {
            transition: all 0.2s;
            box-shadow: none;
        }
        .nav-button:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body>

    <!-- Main App Container -->
    <div id="app" class="relative w-full max-w-md mx-auto bg-light-bg shadow-xl min-h-screen overflow-hidden">
        
        <!-- Fixed Header -->
        <header id="app-header" class="fixed top-0 w-full max-w-md bg-primary-red text-white p-3 z-10 shadow-lg flex justify-between items-center transition-all">
            <h1 class="text-xl font-bold flex items-center">
                <span class="pill-icon text-white transform rotate-45 mr-2">ğŸ’Š</span>å·¥ä¼šè´­è¯å•†åŸ
            </h1>
            <button onclick="logout()" id="logout-btn" class="text-sm border border-white px-2 py-1 rounded-full hover:bg-white hover:text-primary-red transition-colors hidden">
                é€€å‡º
            </button>
        </header>

        <!-- Main View Rendering Area -->
        <main id="view-container" class="content-area overflow-y-auto"></main>
        
        <!-- Fixed Bottom Navigation (Hidden initially) -->
        <nav id="app-footer" class="fixed bottom-0 w-full max-w-md bg-white border-t border-gray-200 shadow-2xl z-10 flex justify-around p-2 hidden">
            <button class="flex flex-col items-center text-xs text-gray-700 nav-button" onclick="navigate('home')">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                é¦–é¡µ
            </button>
            <button class="flex flex-col items-center text-xs text-gray-700 nav-button" onclick="navigate('orders')">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                è®¢å•
            </button>
            <button class="relative flex flex-col items-center text-xs text-primary-red nav-button" onclick="navigate('cart')">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                <span id="cart-count" class="absolute top-0 right-1 bg-primary-red text-white rounded-full h-4 w-4 text-xs flex items-center justify-center opacity-0 transition-opacity">0</span>
                è´­ç‰©è½¦
            </button>
            <button class="flex flex-col items-center text-xs text-gray-700 nav-button" onclick="navigate('customerService')">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 0A7.25 7.25 0 0112 21.75c-3.9 0-7.25-3.35-7.25-7.25S8.1 7.25 12 7.25c3.9 0 7.25 3.35 7.25 7.25S15.9 21.75 12 21.75zm-3.536-3.536L5.636 18.364"></path></svg>
                å®¢æœ
            </button>
            <button class="flex flex-col items-center text-xs text-gray-700 nav-button" onclick="navigate('profile')">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                æˆ‘çš„
            </button>
        </nav>
        
        <!-- Modal for Message/Confirmation -->
        <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-xs text-center">
                <h3 id="modal-title" class="text-lg font-bold mb-3 text-primary-red">æç¤º</h3>
                <p id="modal-body" class="text-gray-700 mb-4"></p>
                <button onclick="closeModal()" class="bg-primary-red text-white px-4 py-2 rounded-lg w-full hover:opacity-90 transition-opacity">
                    ç¡®å®š
                </button>
            </div>
        </div>
        
    </div>

    <script>
        // --- Global State Management ---
        let state = {
            view: 'login',
            user: null, // {id, name, isMember, points}
            cart: [], // [{product, quantity, id}]
            orders: [],
            currentOrder: null, // Used during checkout flow
        };

        const TEST_USERS = {
            'u1': { id: 'u1', name: 'ä¼šå‘˜ç”¨æˆ·A', isMember: true, points: 500, password: '' },
            'u2': { id: 'u2', name: 'éä¼šå‘˜ç”¨æˆ·B', isMember: false, points: 0, password: '' },
            'u3': { id: 'u3', name: 'æ–°ç”¨æˆ·C', isMember: false, points: 0, password: '' },
        };

        const PRODUCTS = [
            { id: 1, name: 'æ„Ÿå†’çµé¢—ç²’', img: 'ğŸ’Š', price: 25.00, member_price: 20.00, is_prescription: false, category: 'æ„Ÿå†’ç”¨è¯', tags: ['å†¬å­£æ¨è', 'çƒ­é—¨'] },
            { id: 2, name: 'ç»´ç”Ÿç´ Cç‰‡', img: 'ğŸŠ', price: 12.50, member_price: 10.00, is_prescription: false, category: 'ç»´ç”Ÿç´ ', tags: ['ä¸­å¹´æ¨è', 'çƒ­é—¨'] },
            { id: 3, name: 'é˜¿è«è¥¿æ—èƒ¶å›Š', img: 'ğŸ’Š', price: 35.00, member_price: 30.00, is_prescription: true, category: 'æŠ—ç”Ÿç´ ', tags: ['å¤„æ–¹è¯'] },
            { id: 4, name: 'å°å„¿é€€çƒ§è´´', img: 'ğŸ‘¶', price: 18.00, member_price: 15.00, is_prescription: false, category: 'å„¿ç§‘ç”¨è¯', tags: ['å„¿ç§‘', 'çƒ­é—¨'] },
            { id: 5, name: 'é’™ç‰‡', img: 'ğŸ¥›', price: 55.00, member_price: 45.00, is_prescription: false, category: 'ç»´ç”Ÿç´ ', tags: ['ä¸­å¹´æ¨è', 'å¥³æ€§'] },
            { id: 6, name: 'è—¿é¦™æ­£æ°”æ°´', img: 'ğŸŒ¿', price: 10.00, member_price: 8.00, is_prescription: false, category: 'è‚ èƒƒç”¨è¯', tags: ['å¤å­£æ¨è'] }
        ];

        const CATEGORIES = ['æ„Ÿå†’ç”¨è¯', 'ç»´ç”Ÿç´ ', 'å„¿ç§‘ç”¨è¯', 'è‚ èƒƒç”¨è¯', 'æŠ—ç”Ÿç´ ', 'ä¸­æˆè¯'];
        
        // --- Utility Functions ---

        /**
         * Navigates to a new view and renders it.
         * @param {string} viewName - The name of the view to navigate to.
         * @param {Object} [data=null] - Optional data to pass to the view renderer.
         */
        function navigate(viewName, data = null) {
            state.view = viewName;
            renderView(data);
        }

        function showMessage(title, message, isHtml = false) {
            document.getElementById('modal-title').textContent = title;
            if (isHtml) {
                document.getElementById('modal-body').innerHTML = message;
            } else {
                document.getElementById('modal-body').textContent = message;
            }
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        // --- Auth Logic ---

        function login() {
            const username = document.getElementById('username').value;
            const user = TEST_USERS[username];

            if (user) {
                state.user = { ...user }; // Copy user data to state
                document.getElementById('logout-btn').classList.remove('hidden');
                document.getElementById('app-footer').classList.remove('hidden');
                navigate('home');
            } else {
                showMessage('ç™»å½•å¤±è´¥', 'æµ‹è¯•è´¦å·ä¸å­˜åœ¨ï¼Œè¯·ä½¿ç”¨ u1 (ä¼šå‘˜) æˆ– u2/u3 (éä¼šå‘˜) ç™»å½•ã€‚');
            }
        }

        function logout() {
            state.user = null;
            state.cart = [];
            document.getElementById('logout-btn').classList.add('hidden');
            document.getElementById('app-footer').classList.add('hidden');
            navigate('login');
        }

        // --- Cart Logic ---

        function updateCartCount() {
            const count = state.cart.reduce((sum, item) => sum + item.quantity, 0);
            const countEl = document.getElementById('cart-count');
            countEl.textContent = count;
            if (count > 0) {
                countEl.classList.remove('opacity-0');
                countEl.classList.add('bg-primary-red');
            } else {
                countEl.classList.add('opacity-0');
                countEl.classList.remove('bg-primary-red');
            }
        }

        function addToCart(productId) {
            const product = PRODUCTS.find(p => p.id === productId);
            if (!product) return;

            const existingItem = state.cart.find(item => item.id === productId);

            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                state.cart.push({ ...product, quantity: 1, id: productId });
            }
            updateCartCount();
            showMessage('æˆåŠŸ', `${product.name} å·²åŠ å…¥è´­ç‰©è½¦!`);
        }

        function updateCartItemQuantity(productId, quantity) {
            const item = state.cart.find(i => i.id === productId);
            if (item) {
                item.quantity = Math.max(1, quantity);
                renderView(); // Re-render cart view
            }
        }

        function removeCartItem(productId) {
            state.cart = state.cart.filter(item => item.id !== productId);
            updateCartCount();
            renderView(); // Re-render cart view
        }
        
        function calculateCartTotals() {
            let subtotal = 0;
            let totalAvailablePoints = 0;
            let maxDeduction = 0;
            const isMember = state.user && state.user.isMember;

            state.cart.forEach(item => {
                const price = isMember ? item.member_price : item.price;
                const itemTotal = price * item.quantity;
                subtotal += itemTotal;

                if (isMember) {
                    // Max deduction is 50% of the item's price
                    const itemMaxDeduction = itemTotal * 0.5;
                    maxDeduction += itemMaxDeduction;
                }
            });

            // Total points available to use
            if (isMember) {
                totalAvailablePoints = Math.floor(state.user.points);
            }

            // Max deduction in points (10 points = 1 Yuan)
            const maxDeductionPoints = Math.min(totalAvailablePoints, maxDeduction * 10);
            
            return { subtotal, maxDeduction, maxDeductionPoints, isMember };
        }


        // --- View Rendering Logic ---

        const viewContainer = document.getElementById('view-container');

        /**
         * Renders the current view based on state.view.
         */
        function renderView(data = null) {
            if (!state.user && state.view !== 'login') {
                return navigate('login'); // Force login if not authenticated
            }
            
            viewContainer.scrollTop = 0; // Scroll to top on view change
            
            switch (state.view) {
                case 'login':
                    viewContainer.innerHTML = renderLoginView();
                    break;
                case 'home':
                    viewContainer.innerHTML = renderHomeView();
                    break;
                case 'cart':
                    viewContainer.innerHTML = renderCartView();
                    break;
                case 'checkout':
                    viewContainer.innerHTML = renderCheckoutView();
                    break;
                case 'prescriptionSupplement':
                    viewContainer.innerHTML = renderPrescriptionSupplementView(data);
                    break;
                case 'paymentResult':
                    viewContainer.innerHTML = renderPaymentResultView(data);
                    break;
                case 'orders':
                    viewContainer.innerHTML = renderOrderHistoryView();
                    break;
                case 'customerService':
                    viewContainer.innerHTML = renderCustomerServiceView();
                    break;
                case 'profile':
                    viewContainer.innerHTML = renderProfileView();
                    break;
                default:
                    viewContainer.innerHTML = '<h2>404 View Not Found</h2>';
            }
            // Update header title based on view
            const headerTitle = document.querySelector('#app-header h1');
            const titles = {
                'home': 'å·¥ä¼šè´­è¯å•†åŸ',
                'cart': 'è´­ç‰©è½¦',
                'checkout': 'ç»“ç®—ä¸­å¿ƒ',
                'prescriptionSupplement': 'å¤„æ–¹è¡¥æ–¹',
                'paymentResult': 'æ”¯ä»˜ç»“æœ',
                'orders': 'æˆ‘çš„è®¢å•',
                'customerService': 'åœ¨çº¿å®¢æœ',
                'profile': 'æˆ‘çš„'
            };
            if (state.view !== 'login') {
                headerTitle.innerHTML = `<span class="pill-icon text-white transform rotate-45 mr-2">ğŸ’Š</span>${titles[state.view] || 'å•†åŸ'}`;
            } else {
                 headerTitle.innerHTML = `<span class="pill-icon text-white transform rotate-45 mr-2">ğŸ’Š</span>å·¥ä¼šè´­è¯å•†åŸ`;
            }
        }

        // --- View HTML Templates ---

        function renderLoginView() {
            return `
                <div class="flex flex-col items-center justify-center h-full pt-16 p-6">
                    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-xs transition-all duration-300">
                        <h2 class="text-3xl font-bold mb-6 text-center text-primary-red">å·¥ä¼šç™»å½•</h2>
                        <p class="text-gray-500 text-sm mb-6 text-center">è¯·ä½¿ç”¨ä»¥ä¸‹æµ‹è¯•è´¦å·ç™»å½•:</p>
                        <ul class="text-sm text-gray-600 mb-6 space-y-1 bg-gray-50 p-3 rounded-lg border border-gray-200">
                            <li><strong>u1:</strong> ä¼šå‘˜ (500 ç§¯åˆ†)</li>
                            <li><strong>u2:</strong> éä¼šå‘˜</li>
                            <li><strong>u3:</strong> éä¼šå‘˜</li>
                        </ul>
                        
                        <div class="mb-4">
                            <label for="username" class="block text-sm font-medium text-gray-700 mb-1">å·¥ä¼šè´¦å· (u1/u2/u3)</label>
                            <input type="text" id="username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-red focus:border-primary-red transition duration-150" value="u1" placeholder="u1 / u2 / u3">
                        </div>
                        <div class="mb-6">
                            <label for="password" class="block text-sm font-medium text-gray-700 mb-1">å¯†ç  (ç©º)</label>
                            <input type="password" id="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed" value="" readonly>
                        </div>
                        <button onclick="login()" class="w-full bg-primary-red text-white py-3 rounded-xl text-lg font-semibold shadow-lg hover:bg-secondary-red transition-all duration-200 transform hover:scale-105">
                            ç«‹å³ç™»å½•
                        </button>
                    </div>
                </div>
            `;
        }

        function renderProductCard(product) {
            const isMember = state.user && state.user.isMember;
            const priceToDisplay = isMember ? product.member_price : product.price;
            const originalPriceDisplay = isMember ? `<span class="text-xs line-through text-gray-400">Â¥${product.price.toFixed(2)}</span>` : '';
            
            let deductionInfo = '';
            if (isMember) {
                const maxDeductible = (product.member_price * 0.5).toFixed(2);
                const maxPoints = (maxDeductible * 10).toFixed(0);
                deductionInfo = `
                    <p class="text-xs text-green-600 font-medium mt-1">
                        ğŸ æœ€å¤šæŠµæ‰£ Â¥${maxDeductible} (${maxPoints} ç§¯åˆ†)
                    </p>
                `;
            }

            return `
                <div class="bg-white p-4 rounded-xl shadow-md border border-gray-100 hover:shadow-lg transition-shadow duration-300">
                    <div class="text-4xl text-center mb-2">${product.img}</div>
                    <h3 class="font-semibold text-gray-800 text-base mb-1 truncate">${product.name}</h3>
                    <p class="text-xs text-gray-500 mb-2">${product.tags.join(' | ')}</p>
                    
                    <div class="flex items-end justify-between">
                        <div>
                            <p class="text-xl font-bold ${isMember ? 'text-primary-red' : 'text-gray-800'}">
                                Â¥${priceToDisplay.toFixed(2)}
                            </p>
                            ${originalPriceDisplay}
                            ${deductionInfo}
                        </div>
                        <button onclick="addToCart(${product.id})" class="bg-primary-red text-white p-2 rounded-full shadow-md hover:bg-secondary-red transition-colors text-sm">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderHomeView() {
            const isMember = state.user.isMember;
            const memberInfo = isMember ? 
                `<div class="flex items-center space-x-2 text-sm">
                    <span class="bg-yellow-500 text-white px-2 py-0.5 rounded-full font-bold">VIP ä¼šå‘˜</span>
                    <span class="text-primary-red">å½“å‰ç§¯åˆ†: ${state.user.points}</span>
                </div>` : 
                `<span class="text-sm text-gray-500">ç™»å½•èº«ä»½: æ™®é€šç”¨æˆ·</span>`;

            // Simple recommendation logic (e.g., Winter/Female/Middle Age)
            const recommendedProducts = PRODUCTS.filter(p => p.tags.includes('çƒ­é—¨') || p.tags.includes('å†¬å­£æ¨è') || p.tags.includes('ä¸­å¹´æ¨è') || p.tags.includes('å„¿ç§‘')).slice(0, 4);
            const otherProducts = PRODUCTS.filter(p => !recommendedProducts.includes(p));

            let html = `
                <div class="p-4 pt-4 space-y-4">
                    <!-- User/Member Info Banner -->
                    <div class="bg-white p-3 rounded-xl shadow-lg border-l-4 border-primary-red">
                        <p class="text-lg font-bold text-gray-800">${state.user.name}ï¼Œæ¬¢è¿å›æ¥!</p>
                        ${memberInfo}
                    </div>

                    <!-- ä¸ªæ€§åŒ–æ¨è -->
                    <h2 class="text-xl font-bold text-gray-800 border-l-4 border-primary-red pl-2">ğŸ’¡ ä¸ªæ€§åŒ–æ¨è</h2>
                    <div class="grid grid-cols-2 gap-4">
                        ${recommendedProducts.map(renderProductCard).join('')}
                    </div>

                    <!-- åº•éƒ¨å…¨é‡åˆ†ç±» (Collapsible) -->
                    <h2 class="text-xl font-bold text-gray-800 border-l-4 border-primary-red pl-2">ğŸ›’ æ‰€æœ‰è¯å“</h2>
                    <div id="full-categories" class="space-y-3">
                        <!-- Simplified Category List -->
                        ${CATEGORIES.map(cat => `
                            <div class="bg-white p-4 rounded-xl shadow-md cursor-pointer border border-gray-200" onclick="toggleCategory('${cat}')">
                                <h3 class="font-bold text-lg text-primary-red">${cat} (${PRODUCTS.filter(p => p.category === cat).length})</h3>
                                <div id="cat-${cat}" class="product-list grid grid-cols-1 gap-4 mt-3 hidden">
                                    ${PRODUCTS.filter(p => p.category === cat).map(renderProductCard).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            return html;
        }

        function toggleCategory(categoryName) {
            const list = document.getElementById(`cat-${categoryName}`);
            list.classList.toggle('hidden');
        }

        function renderCartView() {
            const { subtotal, maxDeduction, maxDeductionPoints, isMember } = calculateCartTotals();
            const hasPrescription = state.cart.some(item => item.is_prescription);

            if (state.cart.length === 0) {
                return `
                    <div class="flex flex-col items-center justify-center h-full pt-16 p-6">
                        <div class="text-6xl mb-4 text-gray-300">ğŸ›’</div>
                        <p class="text-xl text-gray-500 mb-6">æ‚¨çš„è´­ç‰©è½¦æ˜¯ç©ºçš„</p>
                        <button onclick="navigate('home')" class="bg-primary-red text-white px-6 py-3 rounded-full text-lg font-semibold shadow-lg hover:bg-secondary-red transition-colors">
                            å»å•†åŸé€›é€›
                        </button>
                    </div>
                `;
            }

            return `
                <div class="p-4 pt-16 space-y-4">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 border-l-4 border-primary-red pl-2">æˆ‘çš„è´­ç‰©è½¦ (${state.cart.length})</h2>
                    
                    <!-- Cart Items -->
                    <div class="space-y-3">
                        ${state.cart.map(item => `
                            <div class="flex items-center bg-white p-3 rounded-xl shadow-md border border-gray-200">
                                <div class="text-3xl mr-3">${item.img}</div>
                                <div class="flex-grow">
                                    <h3 class="font-semibold text-gray-800">${item.name}</h3>
                                    <p class="text-primary-red font-bold">Â¥${(isMember ? item.member_price : item.price).toFixed(2)}</p>
                                    ${isMember ? `<p class="text-xs text-green-600">ä¼šå‘˜ä»·ï¼šÂ¥${item.member_price.toFixed(2)}</p>` : ''}
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button onclick="updateCartItemQuantity(${item.id}, ${item.quantity - 1})" class="text-gray-500 border rounded-full w-6 h-6">-</button>
                                    <span class="text-lg font-medium">${item.quantity}</span>
                                    <button onclick="updateCartItemQuantity(${item.id}, ${item.quantity + 1})" class="text-primary-red border border-primary-red rounded-full w-6 h-6">+</button>
                                    <button onclick="removeCartItem(${item.id})" class="text-gray-400 hover:text-primary-red">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <!-- Summary -->
                    <div class="bg-white p-4 rounded-xl shadow-lg space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-600">å•†å“æ€»ä»·:</span>
                            <span class="font-bold text-lg">Â¥${subtotal.toFixed(2)}</span>
                        </div>
                        ${isMember ? `
                            <div class="text-sm text-green-600">
                                ğŸ… å¯ç”¨ç§¯åˆ†æŠµæ‰£ä¸Šé™: Â¥${maxDeduction.toFixed(2)} (å…± ${maxDeductionPoints} ç§¯åˆ†)
                            </div>
                        ` : ''}
                        ${hasPrescription ? `
                            <p class="text-xs text-orange-500 font-medium pt-2 border-t border-dashed">
                                <span class="font-bold">æ³¨æ„:</span> è®¢å•åŒ…å«å¤„æ–¹è¯ğŸ’Šï¼Œç»“ç®—æ—¶éœ€å®Œæˆçº¿ä¸Šè¡¥æ–¹ã€‚
                            </p>
                        ` : ''}
                    </div>
                </div>

                <!-- Fixed Checkout Bar -->
                <div class="fixed bottom-16 w-full max-w-md bg-white p-3 border-t border-gray-200 shadow-2xl flex justify-between items-center">
                    <div>
                        <span class="text-gray-600">åº”ä»˜æ€»é¢:</span>
                        <span class="text-2xl font-bold text-primary-red ml-1">Â¥${subtotal.toFixed(2)}</span>
                    </div>
                    <button onclick="navigate('checkout')" class="bg-primary-red text-white px-6 py-3 rounded-full text-lg font-semibold shadow-lg hover:bg-secondary-red transition-all">
                        å»ç»“ç®—
                    </button>
                </div>
            `;
        }
        
        function renderCheckoutView() {
            const { subtotal, maxDeduction, maxDeductionPoints, isMember } = calculateCartTotals();
            const hasPrescription = state.cart.some(item => item.is_prescription);

            // Initialize/reset checkout state for this view
            state.currentOrder = {
                items: state.cart,
                subtotal: subtotal,
                pointsUsed: 0,
                deduction: 0,
                finalAmount: subtotal,
                address: 'å¹¿è¥¿å£®æ—è‡ªæ²»åŒºå—å®å¸‚xxxè¡—é“',
                hasPrescription: hasPrescription,
                isPrescriptionSupplemented: !hasPrescription,
                status: 'å¾…ä»˜æ¬¾',
                trackingId: Math.random().toString(36).substring(2, 11).toUpperCase()
            };

            const pointSection = isMember ? `
                <div class="bg-white p-4 rounded-xl shadow-lg space-y-2">
                    <h3 class="text-lg font-bold text-gray-800 border-l-4 border-green-500 pl-2">ç§¯åˆ†æŠµæ‰£ (10ç§¯åˆ† = 1å…ƒ)</h3>
                    <div class="text-sm text-gray-600">
                        å¯ç”¨ç§¯åˆ†: ${state.user.points} | æœ€å¤šå¯æŠµæ‰£: Â¥${maxDeduction.toFixed(2)} (${maxDeductionPoints} ç§¯åˆ†)
                    </div>
                    <div class="flex space-x-2 items-center">
                        <label for="points-input" class="text-gray-700">ä½¿ç”¨ç§¯åˆ†:</label>
                        <input type="number" id="points-input" class="flex-grow px-3 py-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" 
                                value="0" min="0" max="${maxDeductionPoints}" oninput="updateDeduction(this.value)">
                        <button onclick="updateDeduction(${maxDeductionPoints})" class="bg-green-500 text-white text-xs px-3 py-1 rounded-full hover:bg-green-600">
                            å…¨é¢æŠµæ‰£
                        </button>
                    </div>
                    <p class="text-sm text-green-600 font-bold mt-2">ç§¯åˆ†æŠµæ‰£é‡‘é¢: <span id="deduction-amount">Â¥0.00</span></p>
                </div>
            ` : '';

            let prescriptionNotice = '';
            if (hasPrescription) {
                 prescriptionNotice = `
                    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-xl mt-4">
                        <p class="font-bold">âš ï¸ å¤„æ–¹è¯è­¦å‘Š</p>
                        <p class="text-sm">æ‚¨çš„è®¢å•åŒ…å«å¤„æ–¹è¯ï¼Œéœ€è¦å…ˆè¿›è¡Œåœ¨çº¿è¡¥æ–¹å®¡æ ¸æ‰èƒ½ç»§ç»­æ”¯ä»˜ã€‚</p>
                    </div>
                 `;
            }

            return `
                <div class="p-4 pt-16 space-y-4">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 border-l-4 border-primary-red pl-2">ç»“ç®—ä¿¡æ¯</h2>
                    
                    <!-- Address Card -->
                    <div class="bg-white p-4 rounded-xl shadow-lg space-y-2 border-l-4 border-blue-500">
                        <h3 class="text-lg font-bold text-gray-800">æ”¶è´§åœ°å€</h3>
                        <p class="text-gray-700 font-medium">æ”¶ä»¶äºº: ${state.user.name} (å·¥ä¼šç”¨æˆ·)</p>
                        <p class="text-sm text-gray-500">${state.currentOrder.address}</p>
                        <button class="text-blue-500 text-sm hover:text-blue-700">ä¿®æ”¹åœ°å€ (æ¨¡æ‹Ÿ)</button>
                    </div>

                    <!-- Item List -->
                    <div class="bg-white p-4 rounded-xl shadow-lg space-y-2">
                        <h3 class="text-lg font-bold text-gray-800 border-l-4 border-primary-red pl-2">å•†å“æ¸…å• (${state.cart.length} ä»¶)</h3>
                        ${state.cart.map(item => `
                            <div class="flex justify-between text-sm py-1 border-b border-gray-100 last:border-b-0">
                                <span class="text-gray-700">${item.name} x ${item.quantity}</span>
                                <span class="font-medium">Â¥${((isMember ? item.member_price : item.price) * item.quantity).toFixed(2)}</span>
                            </div>
                        `).join('')}
                        <div class="flex justify-between font-bold pt-2 border-t border-gray-200">
                            <span>å•†å“æ€»è®¡</span>
                            <span>Â¥${subtotal.toFixed(2)}</span>
                        </div>
                    </div>

                    <!-- Point Deduction Section -->
                    ${pointSection}
                    
                    <!-- Prescription Notice -->
                    ${prescriptionNotice}

                    <!-- Final Summary (Placeholders) -->
                    <div class="bg-white p-4 rounded-xl shadow-lg space-y-2 text-right">
                        <div class="text-gray-600">ç§¯åˆ†æŠµæ‰£: <span id="summary-deduction">- Â¥0.00</span></div>
                        <div class="text-2xl font-bold text-primary-red pt-2 border-t border-gray-200">
                            å®ä»˜é‡‘é¢: <span id="final-amount">Â¥${subtotal.toFixed(2)}</span>
                        </div>
                    </div>
                </div>

                <!-- Fixed Payment Bar -->
                <div class="fixed bottom-16 w-full max-w-md bg-white p-3 border-t border-gray-200 shadow-2xl flex justify-between items-center">
                    <div>
                        <span class="text-gray-600">æ€»è®¡:</span>
                        <span id="payment-bar-amount" class="text-2xl font-bold text-primary-red ml-1">Â¥${subtotal.toFixed(2)}</span>
                    </div>
                    <button onclick="processOrder()" class="bg-primary-red text-white px-6 py-3 rounded-full text-lg font-semibold shadow-lg hover:bg-secondary-red transition-all">
                        æäº¤è®¢å•
                    </button>
                </div>
            `;
        }

        // Checkout helper function to update deduction fields
        function updateDeduction(points) {
            const pointsInput = document.getElementById('points-input');
            const { subtotal, maxDeductionPoints, isMember } = calculateCartTotals();
            
            if (!isMember) return;

            // 1. Validate and cap points usage
            let pointsToUse = parseInt(points) || 0;
            pointsToUse = Math.min(pointsToUse, state.user.points); // Cap by user's total points
            pointsToUse = Math.min(pointsToUse, maxDeductionPoints); // Cap by max item deduction limit
            
            pointsInput.value = pointsToUse;
            
            // 2. Calculate deduction amount (10 points = 1 Yuan)
            const deductionAmount = pointsToUse / 10;
            const finalAmount = subtotal - deductionAmount;
            
            // 3. Update state
            state.currentOrder.pointsUsed = pointsToUse;
            state.currentOrder.deduction = deductionAmount;
            state.currentOrder.finalAmount = finalAmount;

            // 4. Update UI
            document.getElementById('deduction-amount').textContent = `Â¥${deductionAmount.toFixed(2)}`;
            document.getElementById('summary-deduction').textContent = `- Â¥${deductionAmount.toFixed(2)}`;
            document.getElementById('final-amount').textContent = `Â¥${finalAmount.toFixed(2)}`;
            document.getElementById('payment-bar-amount').textContent = `Â¥${finalAmount.toFixed(2)}`;
        }

        function processOrder() {
            if (!state.currentOrder) return showMessage('é”™è¯¯', 'è®¢å•ä¿¡æ¯ç¼ºå¤±ã€‚');
            
            // Check for prescription and required supplement step
            if (state.currentOrder.hasPrescription && !state.currentOrder.isPrescriptionSupplemented) {
                // If it has prescription but hasn't supplemented, go to supplement view
                return navigate('prescriptionSupplement', state.currentOrder);
            }

            // Proceed to final payment (simulate)
            const order = { ...state.currentOrder };
            order.date = new Date().toLocaleString('zh-CN');
            
            // Update user points
            if (state.user.isMember) {
                state.user.points -= order.pointsUsed;
            }

            // Move to payment page
            navigate('paymentResult', { success: true, order: order });
            
            // Clear cart and current order state
            state.cart = [];
            state.currentOrder = null;
            updateCartCount();
        }

        function renderPrescriptionSupplementView(order) {
            if (!order || !order.hasPrescription) return navigate('checkout');

            // Find the prescription items for display
            const prescriptionItems = order.items.filter(item => item.is_prescription);

            return `
                <div class="p-4 pt-16 space-y-6">
                    <h2 class="text-2xl font-bold text-primary-red mb-4 border-l-4 border-primary-red pl-2">ğŸ“ å¤„æ–¹è¯è¡¥æ–¹æµç¨‹</h2>
                    
                    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-xl">
                        <p class="font-bold">é‡è¦æç¤ºï¼š</p>
                        <p class="text-sm">æ ¹æ®å›½å®¶è§„å®šï¼Œè´­ä¹°å¤„æ–¹è¯éœ€å‡­ç”µå­å¤„æ–¹ã€‚è¯·é…åˆå®Œæˆä»¥ä¸‹å¥åº·ä¿¡æ¯é‡‡é›†ï¼Œæˆ‘ä»¬å°†æ¨¡æ‹Ÿåœ¨çº¿åŒ»ç”Ÿä¸ºæ‚¨å¼€å…·å¤„æ–¹ã€‚</p>
                    </div>

                    <!-- Prescription Items List -->
                    <div class="bg-white p-4 rounded-xl shadow-lg">
                        <h3 class="font-bold text-lg mb-3">å¾…è¡¥æ–¹è¯å“:</h3>
                        ${prescriptionItems.map(item => `<p class="text-sm text-gray-700">ğŸ’Š ${item.name} x ${item.quantity}</p>`).join('')}
                    </div>

                    <!-- Health Questionnaire (Simplified) -->
                    <div class="bg-white p-4 rounded-xl shadow-lg space-y-4">
                        <h3 class="font-bold text-lg mb-3">å¥åº·ä¿¡æ¯ (è¯·å‹¾é€‰):</h3>
                        
                        <div class="space-y-3" id="health-options">
                            <label class="flex items-center text-gray-700">
                                <input type="checkbox" name="health" value="symptom1" class="form-checkbox text-primary-red rounded mr-2">
                                <span>ç›®å‰æœ‰è½»å¾®å’³å—½/å–‰å’™ç—›ç—‡çŠ¶</span>
                            </label>
                            <label class="flex items-center text-gray-700">
                                <input type="checkbox" name="health" value="history" class="form-checkbox text-primary-red rounded mr-2">
                                <span>æ—¢å¾€æ— è¯ç‰©è¿‡æ•å²</span>
                            </label>
                            <label class="flex items-center text-gray-700">
                                <input type="checkbox" name="health" value="pregnant" class="form-checkbox text-primary-red rounded mr-2">
                                <span>éå­•å¦‡æˆ–å“ºä¹³æœŸå¦‡å¥³</span>
                            </label>
                        </div>
                    </div>

                    <!-- Simulated Doctor's Review & Submit -->
                    <button onclick="simulatePrescriptionReview()" class="w-full bg-primary-red text-white py-3 rounded-xl text-lg font-semibold shadow-lg hover:bg-secondary-red transition-all transform hover:scale-105">
                        æäº¤å¥åº·ä¿¡æ¯ï¼Œç”Ÿæˆç”µå­å¤„æ–¹
                    </button>
                    
                </div>
            `;
        }

        function simulatePrescriptionReview() {
            // Check if at least one option is checked (simple validation)
            const options = document.querySelectorAll('#health-options input:checked');
            if (options.length === 0) {
                return showMessage('æç¤º', 'è¯·è‡³å°‘å‹¾é€‰ä¸€ä¸ªå¥åº·ä¿¡æ¯é€‰é¡¹ä»¥ä¾¿åŒ»ç”Ÿå®¡æ ¸ã€‚');
            }

            // Simulate prescription approval
            showMessage('è¡¥æ–¹æˆåŠŸ', 'ğŸ‘©â€âš•ï¸ æ‚¨çš„å¥åº·ä¿¡æ¯å·²é€šè¿‡åœ¨çº¿åŒ»ç”Ÿå®¡æ ¸ï¼Œç”µå­å¤„æ–¹å·²å¼€å…·ã€‚æ‚¨å¯ä»¥ç»§ç»­æ”¯ä»˜äº†ã€‚');
            
            // Update order state to reflect supplementation is done
            state.currentOrder.isPrescriptionSupplemented = true;
            
            // Go back to checkout to finalize
            navigate('checkout');
        }

        function renderPaymentResultView(data) {
            const { success, order } = data;
            const icon = success ? 'âœ…' : 'âŒ';
            const title = success ? 'æ”¯ä»˜æˆåŠŸ!' : 'æ”¯ä»˜å¤±è´¥';
            const message = success ? 
                `æ‚¨çš„è®¢å• (Â¥${order.finalAmount.toFixed(2)}) å·²æˆåŠŸæäº¤ï¼Œæˆ‘ä»¬å°†å°½å¿«ä¸ºæ‚¨å‘è´§ï¼` : 
                'æ”¯ä»˜è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡æ–°å°è¯•ã€‚';

            if (success) {
                // Add the successful order to history
                state.orders.unshift(order);
            }

            return `
                <div class="flex flex-col items-center justify-center h-full pt-16 p-6 space-y-6">
                    <div class="text-7xl mb-4">${icon}</div>
                    <h2 class="text-3xl font-bold ${success ? 'text-green-600' : 'text-primary-red'}">${title}</h2>
                    <p class="text-lg text-gray-700 text-center">${message}</p>
                    
                    ${success ? `
                        <div class="bg-white p-4 rounded-xl shadow-lg w-full max-w-xs space-y-2 text-sm border-t-4 border-green-500">
                            <p><strong>è®¢å•ç¼–å·:</strong> ${order.trackingId}</p>
                            <p><strong>å®ä»˜é‡‘é¢:</strong> Â¥${order.finalAmount.toFixed(2)}</p>
                            ${order.deduction > 0 ? `<p><strong>ç§¯åˆ†æŠµæ‰£:</strong> -Â¥${order.deduction.toFixed(2)} (${order.pointsUsed} ç§¯åˆ†)</p>` : ''}
                        </div>
                    ` : ''}

                    <div class="flex space-x-4 pt-4">
                        <button onclick="navigate('home')" class="bg-gray-200 text-gray-800 px-6 py-3 rounded-full font-semibold hover:bg-gray-300 transition-colors">
                            è¿”å›é¦–é¡µ
                        </button>
                        <button onclick="navigate('orders')" class="bg-primary-red text-white px-6 py-3 rounded-full font-semibold shadow-lg hover:bg-secondary-red transition-colors">
                            æŸ¥çœ‹è®¢å•
                        </button>
                    </div>
                </div>
            `;
        }

        function renderOrderHistoryView() {
            if (state.orders.length === 0) {
                return `
                    <div class="flex flex-col items-center justify-center h-full pt-16 p-6">
                        <div class="text-6xl mb-4 text-gray-300">ğŸ“¦</div>
                        <p class="text-xl text-gray-500 mb-6">æ‚¨è¿˜æ²¡æœ‰ä»»ä½•è®¢å•</p>
                        <button onclick="navigate('home')" class="bg-primary-red text-white px-6 py-3 rounded-full text-lg font-semibold shadow-lg hover:bg-secondary-red transition-colors">
                            å»å•†åŸé€›é€›
                        </button>
                    </div>
                `;
            }

            return `
                <div class="p-4 pt-16 space-y-4">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 border-l-4 border-primary-red pl-2">å†å²è®¢å• (${state.orders.length})</h2>
                    
                    <div class="space-y-4">
                        ${state.orders.map(order => `
                            <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-100 space-y-2">
                                <div class="flex justify-between items-center border-b pb-2 mb-2">
                                    <p class="text-sm text-gray-500">è®¢å•å·: ${order.trackingId}</p>
                                    <span class="text-sm font-bold ${order.status === 'å¾…ä»˜æ¬¾' ? 'text-orange-500' : 'text-green-600'}">${order.status}</span>
                                </div>
                                
                                <!-- Items Summary -->
                                ${order.items.slice(0, 1).map(item => `
                                    <div class="flex items-center text-sm">
                                        <span class="text-xl mr-2">${item.img}</span>
                                        <span class="text-gray-700 truncate">${item.name} ç­‰ ${order.items.length} ä»¶å•†å“</span>
                                    </div>
                                `).join('')}

                                <div class="text-right pt-2 border-t border-gray-100">
                                    <span class="text-gray-600">å®ä»˜:</span>
                                    <span class="text-xl font-bold text-primary-red ml-1">Â¥${order.finalAmount.toFixed(2)}</span>
                                </div>

                                <button onclick="viewTracking('${order.trackingId}')" class="w-full bg-primary-red text-white py-2 rounded-lg text-sm font-semibold hover:bg-secondary-red transition-colors mt-2">
                                    æŸ¥çœ‹ç‰©æµ
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function viewTracking(trackingId) {
            const trackingInfo = `
                <p><strong>è®¢å•ç¼–å·:</strong> ${trackingId}</p>
                <div class="mt-3 space-y-1 text-sm text-left">
                    <p>ğŸ“¦ 2025-10-26 10:00: è®¢å•å·²æäº¤ï¼Œå¾…å•†å®¶å‘è´§</p>
                    <p>ğŸšš 2025-10-26 12:30: å•†å“å·²å‡ºåº“ï¼Œæ­£åœ¨æ‰“åŒ…</p>
                    <p>âœˆï¸ 2025-10-26 16:00: å¿«ä»¶å·²æ½æ”¶ï¼Œç¦»å¼€å—å®</p>
                    <p>ğŸ“ 2025-10-27 08:00: å¿«ä»¶åˆ°è¾¾ç›®çš„åœ°ä¸­è½¬ç«™</p>
                </div>
            `;
            showMessage('ç‰©æµè¿½è¸ª', trackingInfo, true);
        }

        function renderCustomerServiceView() {
            return `
                <div class="p-4 pt-16 space-y-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 border-l-4 border-primary-red pl-2">ğŸ“ åœ¨çº¿å®¢æœ</h2>
                    
                    <!-- Chat Simulation -->
                    <div class="bg-white p-4 rounded-xl shadow-lg h-96 overflow-y-auto space-y-4" id="chat-window">
                        <!-- AI Message 1 -->
                        <div class="flex justify-start">
                            <div class="bg-gray-200 p-3 rounded-xl max-w-xs">
                                <p class="font-bold text-primary-red">AI æ™ºèƒ½å®¢æœ</p>
                                <p class="text-sm">æ‚¨å¥½ï¼æˆ‘æ˜¯AIæ™ºèƒ½å®¢æœï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨ï¼Ÿæˆ‘å¯ä»¥è§£ç­”ä»¥ä¸‹é—®é¢˜:</p>
                                <ul class="list-disc pl-5 text-xs mt-1 space-y-0.5">
                                    <li>é€€è´§æ”¿ç­–</li>
                                    <li>å‘ç¥¨ç”³è¯·</li>
                                    <li>ä¼šå‘˜ç¦åˆ©</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="bg-white p-4 rounded-xl shadow-2xl flex space-x-3">
                        <input type="text" id="chat-input" class="flex-grow px-4 py-2 border border-gray-300 rounded-full focus:ring-primary-red focus:border-primary-red transition duration-150" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜...">
                        <button onclick="sendChatMessage()" class="bg-primary-red text-white p-2 rounded-full hover:bg-secondary-red transition-colors flex-shrink-0">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                        </button>
                    </div>

                    <!-- Options -->
                    <div class="flex justify-around text-sm">
                        <button onclick="switchCustomerService('human')" class="text-blue-500 hover:text-blue-700 font-medium">è½¬äººå·¥å®¢æœ</button>
                        <button onclick="switchCustomerService('AI')" class="text-primary-red hover:text-secondary-red font-medium">ç»§ç»­ä½¿ç”¨ AI</button>
                    </div>
                </div>
            `;
        }

        let isHumanService = false;

        function switchCustomerService(type) {
            isHumanService = type === 'human';
            const chatWindow = document.getElementById('chat-window');
            const message = isHumanService ? 
                'ğŸ‘©â€ğŸ’¼ å·²ä¸ºæ‚¨è½¬æ¥è‡³äººå·¥å®¢æœï¼Œè¯·ç¨å€™...' : 
                'ğŸ¤– é‡æ–°è¿æ¥ AI æ™ºèƒ½å®¢æœã€‚';
            
            const messageHtml = `
                <div class="flex justify-start">
                    <div class="bg-yellow-100 p-3 rounded-xl max-w-xs text-sm">
                        <p class="font-bold">${isHumanService ? 'äººå·¥å®¢æœ' : 'AI æ™ºèƒ½å®¢æœ'}</p>
                        <p>${message}</p>
                    </div>
                </div>
            `;
            chatWindow.innerHTML += messageHtml;
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function sendChatMessage() {
            const inputEl = document.getElementById('chat-input');
            const chatWindow = document.getElementById('chat-window');
            const userText = inputEl.value.trim();

            if (!userText) return;

            // Display user message
            const userMessageHtml = `
                <div class="flex justify-end">
                    <div class="bg-primary-red text-white p-3 rounded-xl max-w-xs text-sm">${userText}</div>
                </div>
            `;
            chatWindow.innerHTML += userMessageHtml;

            // Clear input
            inputEl.value = '';

            // Simulate AI/Human response delay
            setTimeout(() => {
                let responseText;
                if (isHumanService) {
                    responseText = 'æ­£åœ¨ä¸ºæ‚¨å¤„ç†æ‚¨çš„é—®é¢˜ï¼Œè¯·ç¨å€™ã€‚';
                } else {
                    // Simple AI logic
                    if (userText.includes('é€€è´§') || userText.includes('é€€æ¬¾')) {
                        responseText = 'æˆ‘ä»¬çš„é€€è´§æ”¿ç­–æ˜¯ï¼šè¯å“éè´¨é‡é—®é¢˜ï¼Œä¸€ç»å”®å‡ºä¸æ”¯æŒé€€æ¢ï¼Œè¯·æ‚¨è°…è§£ã€‚';
                    } else if (userText.includes('å‘ç¥¨')) {
                        responseText = 'æ‚¨å¯ä»¥åœ¨è®¢å•å®Œæˆåçš„7ä¸ªå·¥ä½œæ—¥å†…ï¼Œåœ¨è®¢å•è¯¦æƒ…é¡µç”³è¯·ç”µå­å‘ç¥¨ã€‚';
                    } else if (userText.includes('ä¼šå‘˜')) {
                        responseText = 'ä¼šå‘˜å¯äº«å—ä¸“å±ä¼šå‘˜ä»·å’Œç§¯åˆ†æŠµæ‰£æœåŠ¡ (10ç§¯åˆ†=1å…ƒï¼Œæœ€å¤šæŠµæ‰£50%)ã€‚';
                    } else {
                        responseText = 'æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•ç†è§£æ‚¨çš„é—®é¢˜ã€‚æ‚¨å¯ä»¥å°è¯•è½¬äººå·¥å®¢æœã€‚';
                    }
                }

                const responseHtml = `
                    <div class="flex justify-start">
                        <div class="bg-gray-200 p-3 rounded-xl max-w-xs text-sm">
                            <p class="font-bold ${isHumanService ? 'text-blue-600' : 'text-primary-red'}">${isHumanService ? 'äººå·¥å®¢æœ' : 'AI æ™ºèƒ½å®¢æœ'}</p>
                            <p>${responseText}</p>
                        </div>
                    </div>
                `;
                chatWindow.innerHTML += responseHtml;
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }, 800);
        }

        function renderProfileView() {
            const isMember = state.user && state.user.isMember;
            const memberBadge = isMember ? 
                `<div class="bg-gradient-to-r from-yellow-400 to-yellow-500 text-white px-3 py-1 rounded-full text-sm font-bold">
                    VIP ä¼šå‘˜
                </div>` : 
                `<div class="bg-gray-200 text-gray-600 px-3 py-1 rounded-full text-sm">
                    æ™®é€šç”¨æˆ·
                </div>`;

            return `
                <div class="p-4 pt-16 space-y-6">
                    <!-- User Profile Header -->
                    <div class="bg-gradient-to-r from-primary-red to-secondary-red text-white p-6 rounded-xl shadow-lg">
                        <div class="flex items-center space-x-4">
                            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                                </svg>
                            </div>
                            <div class="flex-grow">
                                <h2 class="text-xl font-bold">${state.user.name}</h2>
                                <p class="text-sm opacity-90">å·¥ä¼šç”¨æˆ·</p>
                                ${memberBadge}
                            </div>
                        </div>
                        ${isMember ? `
                            <div class="mt-4 bg-white bg-opacity-20 rounded-lg p-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm">å½“å‰ç§¯åˆ†</span>
                                    <span class="text-2xl font-bold">${state.user.points}</span>
                                </div>
                                <p class="text-xs opacity-80 mt-1">10ç§¯åˆ† = 1å…ƒï¼Œæœ€å¤šæŠµæ‰£50%</p>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Quick Stats -->
                    <div class="grid grid-cols-3 gap-4">
                        <div class="bg-white p-4 rounded-xl shadow-md text-center">
                            <div class="text-2xl font-bold text-primary-red">${state.orders.length}</div>
                            <div class="text-sm text-gray-600">æ€»è®¢å•</div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-md text-center">
                            <div class="text-2xl font-bold text-green-600">${state.orders.filter(o => o.status !== 'å¾…ä»˜æ¬¾').length}</div>
                            <div class="text-sm text-gray-600">å·²å®Œæˆ</div>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-md text-center">
                            <div class="text-2xl font-bold text-blue-600">${state.cart.length}</div>
                            <div class="text-sm text-gray-600">è´­ç‰©è½¦</div>
                        </div>
                    </div>

                    <!-- Menu Items -->
                    <div class="space-y-3">
                        <h3 class="text-lg font-bold text-gray-800 border-l-4 border-primary-red pl-2">è´¦æˆ·ç®¡ç†</h3>
                        
                        <div class="bg-white rounded-xl shadow-md overflow-hidden">
                            <button onclick="navigate('orders')" class="w-full flex items-center justify-between p-4 hover:bg-gray-50 transition-colors">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                        </svg>
                                    </div>
                                    <span class="text-gray-800">æˆ‘çš„è®¢å•</span>
                                </div>
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                            
                            <div class="border-t border-gray-100"></div>
                            
                            <button onclick="navigate('cart')" class="w-full flex items-center justify-between p-4 hover:bg-gray-50 transition-colors">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center">
                                        <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                        </svg>
                                    </div>
                                    <span class="text-gray-800">è´­ç‰©è½¦</span>
                                </div>
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>

                        <h3 class="text-lg font-bold text-gray-800 border-l-4 border-primary-red pl-2 mt-6">æœåŠ¡ä¸å¸®åŠ©</h3>
                        
                        <div class="bg-white rounded-xl shadow-md overflow-hidden">
                            <button onclick="navigate('customerService')" class="w-full flex items-center justify-between p-4 hover:bg-gray-50 transition-colors">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                        </svg>
                                    </div>
                                    <span class="text-gray-800">åœ¨çº¿å®¢æœ</span>
                                </div>
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                            
                            <div class="border-t border-gray-100"></div>
                            
                            <button onclick="showMessage('åŠŸèƒ½å¼€å‘ä¸­', 'æ­¤åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼')" class="w-full flex items-center justify-between p-4 hover:bg-gray-50 transition-colors">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <span class="text-gray-800">å¸®åŠ©ä¸­å¿ƒ</span>
                                </div>
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>

                        <h3 class="text-lg font-bold text-gray-800 border-l-4 border-primary-red pl-2 mt-6">è®¾ç½®</h3>
                        
                        <div class="bg-white rounded-xl shadow-md overflow-hidden">
                            <button onclick="showMessage('åŠŸèƒ½å¼€å‘ä¸­', 'æ­¤åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼')" class="w-full flex items-center justify-between p-4 hover:bg-gray-50 transition-colors">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center">
                                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                    </div>
                                    <span class="text-gray-800">è´¦æˆ·è®¾ç½®</span>
                                </div>
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                            
                            <div class="border-t border-gray-100"></div>
                            
                            <button onclick="logout()" class="w-full flex items-center justify-between p-4 hover:bg-gray-50 transition-colors">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center">
                                        <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                        </svg>
                                    </div>
                                    <span class="text-gray-800">é€€å‡ºç™»å½•</span>
                                </div>
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- Initialization ---

        function init() {
            // Initial render: always start at login view
            if (!state.user) {
                navigate('login');
            } else {
                // If the user were persisted (not needed here but good practice), restore view
                document.getElementById('logout-btn').classList.remove('hidden');
                document.getElementById('app-footer').classList.remove('hidden');
                navigate('home');
            }
            updateCartCount();
        }

        // Start the application
        init();

    </script>

</body>
</html>
